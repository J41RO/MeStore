# REDIS IMMEDIATE SECURITY FIX - MeStore Backend Security
# ---------------------------------------------------------------------------------------------
# SECURITY BACKEND AI - IMMEDIATE DEPLOYMENT CONFIGURATION
# Risk Level: CRITICAL â†’ SECURE
# Deployment Priority: IMMEDIATE
# Environment: Development/Staging/Production Ready
# ---------------------------------------------------------------------------------------------

# ===== NETWORK SECURITY =====
# Bind to specific interfaces only - NO wildcard binding
bind 127.0.0.1 192.168.1.137
protected-mode yes
port 6379
timeout 300
tcp-keepalive 300

# ===== AUTHENTICATION - IMMEDIATE FIX =====
# CRITICAL: Enable authentication immediately
requirepass mestore-redis-secure-password-2025-min-32-chars

# ===== DANGEROUS COMMAND RESTRICTIONS =====
# Disable commands that can cause data loss or security issues
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG-MESTORE-ADMIN-9X7K2L"
rename-command DEBUG ""
rename-command EVAL "EVAL-MESTORE-SECURE-8H3M9P"

# ===== MEMORY PROTECTION =====
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# ===== PERSISTENCE - SECURE =====
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# Enable AOF for data durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ===== SECURITY LOGGING =====
loglevel notice
logfile /data/redis-security.log

# ===== PERFORMANCE MONITORING =====
slowlog-log-slower-than 10000
slowlog-max-len 128
latency-monitor-threshold 100

# ===== CLIENT MANAGEMENT =====
maxclients 10000
timeout 300

# ===== SECURITY NOTIFICATIONS =====
# Enable keyspace notifications for security monitoring
notify-keyspace-events "Ex"

# ===== SESSION SECURITY =====
# Multiple databases for separation of concerns
databases 16

# ===== MESTORE SPECIFIC SECURITY =====
# Database allocation:
# DB 0: General cache
# DB 1: User sessions (critical security)
# DB 2: Message queues
# DB 3: Rate limiting data
# DB 4: Audit logs
# DB 5: Temporary data
# DB 6-15: Reserved for future use

# ===== PRODUCTION HARDENING =====
# Disable potentially dangerous features
always-show-logo no
protected-mode yes

# ===== CLIENT BUFFER LIMITS =====
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ===== SCRIPT SECURITY =====
lua-time-limit 5000

# ===== DEPLOYMENT INSTRUCTIONS =====
# 1. Stop current Redis service
# 2. Backup current data: redis-cli BGSAVE
# 3. Copy this configuration to Redis config directory
# 4. Update application connection strings (see redis-connection-strings.env)
# 5. Start Redis with new configuration
# 6. Test authentication: redis-cli -a mestore-redis-secure-password-2025-min-32-chars ping
# 7. Verify application connectivity
# 8. Monitor logs for authentication failures