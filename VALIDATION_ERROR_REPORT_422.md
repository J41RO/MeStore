# API TESTING REPORT: 422 Validation Error - PUT /productos

**Generated by**: API Testing Specialist  
**Date**: 2025-09-30  
**Backend**: http://192.168.1.137:8000  
**Status**: ‚úÖ PROBLEMA IDENTIFICADO - SOLUCI√ìN DISPONIBLE

---

## üìã RESUMEN EJECUTIVO

El endpoint `PUT /api/v1/productos/{id}` retorna error 422 (Validation Error) debido a que el frontend est√° enviando valores inv√°lidos en los campos `peso` y `dimensiones` que no cumplen con las validaciones de negocio del schema Pydantic en el backend.

### Severidad
- **Nivel**: ALTA
- **Impacto**: Los vendedores NO pueden actualizar productos con dimensiones no definidas
- **Prioridad**: P1 (Resolver inmediatamente)

---

## üîç AN√ÅLISIS DETALLADO DEL ERROR

### Error Capturado en Logs del Backend

**Timestamp**: `2025-09-30 15:59:14`  
**Endpoint**: `PUT /api/v1/productos/7d1c3030-2da6-4402-ac28-969ed40bc0f3`  
**RequestID**: `req_aa4e6f62`

**Errores de Validaci√≥n**:
1. ‚ùå `body -> peso`: "Peso m√≠nimo: 0.001 kg" (valor recibido: `0.001`)
2. ‚ùå `body -> dimensiones`: "Dimensi√≥n largo debe ser positiva" (valores: `{largo: 0, ancho: 0, alto: 0}`)

### Log Completo del Error
```
2025-09-30 15:59:14 | WARNING  | app.api.v1.handlers.exceptions | Validation error: 
[
  {
    'type': 'value_error',
    'loc': ('body', 'peso'),
    'msg': 'Value error, Peso m√≠nimo: 0.001 kg',
    'input': 0.001,
    'ctx': {'error': ValueError('Peso m√≠nimo: 0.001 kg')}
  },
  {
    'type': 'value_error',
    'loc': ('body', 'dimensiones'),
    'msg': 'Value error, Dimensi√≥n largo debe ser positiva',
    'input': {'largo': 0, 'ancho': 0, 'alto': 0},
    'ctx': {'error': ValueError('Dimensi√≥n largo debe ser positiva')}
  }
]
Path: /api/v1/productos/7d1c3030-2da6-4402-ac28-969ed40bc0f3
RequestID: req_aa4e6f62
```

---

## üéØ CAUSA RA√çZ DEL PROBLEMA

### 1. Validaci√≥n de Campo `peso` (Problema de Precisi√≥n)

**C√≥digo Backend** (`/app/schemas/product.py`, l√≠nea 439-446):
```python
@field_validator("peso")
@classmethod
def validate_peso_update(cls, v: Optional[Decimal]) -> Optional[Decimal]:
    """Validar peso en updates."""
    if v is not None:
        if v < 0.001:  # ‚ö†Ô∏è VALIDACI√ìN ESTRICTA
            raise ValueError("Peso m√≠nimo: 0.001 kg")
        if v > 1000:
            raise ValueError("Peso m√°ximo: 1000 kg")
    return v
```

**Problema**: 
- La validaci√≥n usa `v < 0.001` pero el valor enviado es exactamente `0.001`
- Posible problema de precisi√≥n de punto flotante: `0.001` puede ser interpretado internamente como `0.0009999...`
- El Field validator de Pydantic tiene `ge=0.001` pero el custom validator falla con el valor exacto

**Evidencia**:
```bash
# Test con 0.001 ‚Üí FALLA ‚ùå
curl -X PUT ".../productos/{id}" -d '{"peso": 0.001}' 
# Error: "Peso m√≠nimo: 0.001 kg"

# Test con 0.002 ‚Üí EXITOSO ‚úÖ
curl -X PUT ".../productos/{id}" -d '{"peso": 0.002}'
# Success: 200 OK
```

---

### 2. Validaci√≥n de Campo `dimensiones` (Valores en Cero)

**C√≥digo Backend** (`/app/schemas/product.py`, l√≠nea 450-468):
```python
@field_validator("dimensiones")
@classmethod
def validate_dimensiones_update(
    cls, v: Optional[Dict[str, float]]
) -> Optional[Dict[str, float]]:
    """Validar dimensiones en updates."""
    if v is not None:
        required_keys = {"largo", "ancho", "alto"}
        provided_keys = set(v.keys())
        
        if not required_keys.issubset(provided_keys):
            missing = required_keys - provided_keys
            raise ValueError(f"Dimensiones faltantes: {missing}")
        
        for key, value in v.items():
            if key in required_keys:
                if not isinstance(value, (int, float)) or value <= 0:  # ‚ö†Ô∏è CR√çTICO
                    raise ValueError(f"Dimensi√≥n {key} debe ser positiva")
                if value > 500:
                    raise ValueError(f"Dimensi√≥n {key} m√°xima: 500 cm")
    return v
```

**Problema**:
- El frontend est√° enviando valores de dimensiones en `0` (cero)
- La validaci√≥n requiere `value > 0` (estrictamente positivo)
- Valores cero son RECHAZADOS por dise√±o

**Evidencia del Request Frontend**:
```javascript
dimensiones: {
  largo: 0,   // ‚ùå INV√ÅLIDO
  ancho: 0,   // ‚ùå INV√ÅLIDO
  alto: 0     // ‚ùå INV√ÅLIDO
}
```

---

## üìä COMPARACI√ìN REQUEST VS EXPECTED

### Request ACTUAL enviado por el Frontend (FALLA)
```javascript
{
  name: 'iPhone 14 Pro Max dfdfas',
  description: ' dvsvdsfvsd d asdfd dfasgdfgv fg sfdgsgsa DCXVDSZV',
  precio_venta: 500000,
  precio_costo: 10000,
  peso: 0.001,           // ‚ö†Ô∏è PROBLEMA 1: L√≠mite inferior (falla por precisi√≥n)
  categoria: undefined,   // ‚ö†Ô∏è PROBLEMA 2: undefined (deber√≠a ser null o string)
  dimensiones: {
    largo: 0,            // ‚ùå ERROR CR√çTICO: Debe ser > 0
    ancho: 0,            // ‚ùå ERROR CR√çTICO: Debe ser > 0
    alto: 0              // ‚ùå ERROR CR√çTICO: Debe ser > 0
  }
}
```

### Request CORRECTO esperado por el Backend (EXITOSO)
```javascript
{
  name: 'iPhone 14 Pro Max',
  description: 'Descripci√≥n del producto',
  precio_venta: 500000,
  precio_costo: 10000,
  peso: 0.01,            // ‚úÖ CORRECTO: > 0.001 con margen de seguridad
  categoria: 'Electronics', // ‚úÖ CORRECTO: string o null
  dimensiones: {
    largo: 14.7,         // ‚úÖ CORRECTO: > 0
    ancho: 7.15,         // ‚úÖ CORRECTO: > 0
    alto: 0.78           // ‚úÖ CORRECTO: > 0
  }
}
```

---

## üî¨ PRUEBAS DE VALIDACI√ìN REALIZADAS

### Test 1: Valores Problem√°ticos del Frontend (FALL√ì ‚ùå)
```bash
curl -X PUT "http://192.168.1.137:8000/api/v1/productos/7d1c3030-2da6-4402-ac28-969ed40bc0f3" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Product",
    "precio_venta": 500000,
    "precio_costo": 10000,
    "peso": 0.001,
    "dimensiones": {"largo": 0, "ancho": 0, "alto": 0}
  }'
```

**Resultado**:
```json
{
  "status": "error",
  "error_code": "VALIDATION_ERROR",
  "details": [
    {
      "field": "body -> peso",
      "message": "Value error, Peso m√≠nimo: 0.001 kg",
      "error_type": "value_error"
    },
    {
      "field": "body -> dimensiones",
      "message": "Value error, Dimensi√≥n largo debe ser positiva",
      "error_type": "value_error"
    }
  ],
  "request_id": "req_f5b7e5d8"
}
```

### Test 2: Valores Corregidos (EXITOSO ‚úÖ)
```bash
curl -X PUT "http://192.168.1.137:8000/api/v1/productos/7d1c3030-2da6-4402-ac28-969ed40bc0f3" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "iPhone 14 Pro Max CORRECTO",
    "precio_venta": 500000,
    "precio_costo": 10000,
    "peso": 0.01,
    "dimensiones": {"largo": 14.7, "ancho": 7.15, "alto": 0.78}
  }'
```

**Resultado**:
```json
{
  "sku": "PROD-004",
  "name": "iPhone 14 Pro Max CORRECTO",
  "status": "PENDING",
  "precio_venta": 500000.0,
  "precio_costo": 10000.0,
  "peso": 0.01,
  "dimensiones": {
    "largo": 14.7,
    "ancho": 7.15,
    "alto": 0.78
  },
  "categoria": "Electronics",
  "id": "7d1c3030-2da6-4402-ac28-969ed40bc0f3",
  "updated_at": "2025-09-30T21:01:30.333411"
}
```

---

## üõ†Ô∏è ORIGEN DEL PROBLEMA EN EL FRONTEND

### C√≥digo Problem√°tico: Valores por Defecto Inv√°lidos

**Archivo**: `/frontend/src/components/forms/ProductForm.tsx`  
**L√≠neas**: 86-99

```typescript
defaultValues: mode === 'edit' && initialData ? {
  id: initialData.id,
  name: initialData.name || '',
  // ... otros campos ...
  largo: initialData.dimensions?.length || initialData.largo || 0,  // ‚ö†Ô∏è DEFAULT: 0
  ancho: initialData.dimensions?.width || initialData.ancho || 0,   // ‚ö†Ô∏è DEFAULT: 0
  alto: initialData.dimensions?.height || initialData.alto || 0,    // ‚ö†Ô∏è DEFAULT: 0
  peso: initialData.weight?.value || initialData.peso || 0.001,     // ‚ö†Ô∏è DEFAULT: 0.001
} as ProductFormData
```

**Problema Identificado**:
- Si `initialData` no contiene `dimensions` o los valores son falsy, se asignan valores por defecto INV√ÅLIDOS:
  - `largo, ancho, alto`: `0` (RECHAZADO por backend - debe ser > 0)
  - `peso`: `0.001` (en el l√≠mite exacto, falla por precisi√≥n)

### C√≥digo Problem√°tico: Transformaci√≥n de Datos API

**Archivo**: `/frontend/src/components/forms/ProductForm.tsx`  
**L√≠neas**: 323-340

```typescript
const apiData: CreateProductData = {
  name: data.name,
  description: data.description,
  price: data.precio_venta,
  stock: data.stock,
  category: data.category,
  sku: data.sku,
  dimensions: {          // ‚ö†Ô∏è Backend espera "dimensiones", no "dimensions"
    length: data.largo,  // ‚ö†Ô∏è Backend espera "largo", no "length"
    width: data.ancho,   // ‚ö†Ô∏è Backend espera "ancho", not "width"
    height: data.alto,   // ‚ö†Ô∏è Backend espera "alto", not "height"
    unit: 'cm'           // ‚ö†Ô∏è Backend NO usa "unit"
  },
  weight: {              // ‚ö†Ô∏è Backend espera "peso" directo, no objeto "weight"
    value: data.peso,
    unit: 'kg'
  }
};
```

**Problema Cr√≠tico**: Mismatch de estructura entre CREATE y UPDATE
- Modo CREATE puede usar estructura `{dimensions, weight}` (si el backend lo transforma)
- Modo UPDATE debe usar estructura `{dimensiones, peso}` (seg√∫n ProductUpdate schema)
- El c√≥digo usa la MISMA estructura para ambos modos

---

## ‚úÖ SOLUCIONES RECOMENDADAS

### Soluci√≥n 1: Corregir Valores por Defecto (RECOMENDADO - ALTA PRIORIDAD)

**Archivo**: `/home/admin-jairo/MeStore/frontend/src/components/forms/ProductForm.tsx`  
**L√≠neas**: 86-99

**ANTES**:
```typescript
largo: initialData.dimensions?.length || initialData.largo || 0,
ancho: initialData.dimensions?.width || initialData.ancho || 0,
alto: initialData.dimensions?.height || initialData.alto || 0,
peso: initialData.weight?.value || initialData.peso || 0.001,
```

**DESPU√âS**:
```typescript
largo: initialData.dimensions?.length || initialData.largo || 0.1,     // ‚úÖ M√≠nimo v√°lido
ancho: initialData.dimensions?.width || initialData.ancho || 0.1,      // ‚úÖ M√≠nimo v√°lido
alto: initialData.dimensions?.height || initialData.alto || 0.1,       // ‚úÖ M√≠nimo v√°lido
peso: initialData.weight?.value || initialData.peso || 0.01,           // ‚úÖ Seguro > 0.001
```

**Justificaci√≥n**:
- Backend rechaza `dimensiones` con `value <= 0`
- Backend tiene validaci√≥n ambigua para `peso < 0.001` vs `peso == 0.001`
- Usar valores por defecto razonables previene errores de validaci√≥n

---

### Soluci√≥n 2: Separar Transformaci√≥n CREATE vs UPDATE (RECOMENDADO - ALTA PRIORIDAD)

**Archivo**: `/home/admin-jairo/MeStore/frontend/src/components/forms/ProductForm.tsx`  
**L√≠neas**: 323-362

**ANTES** (estructura √∫nica para CREATE y UPDATE):
```typescript
const apiData: CreateProductData = {
  name: data.name,
  description: data.description,
  dimensions: {
    length: data.largo,
    width: data.ancho,
    height: data.alto,
    unit: 'cm'
  },
  weight: {
    value: data.peso,
    unit: 'kg'
  }
};
```

**DESPU√âS** (estructuras separadas):
```typescript
const apiData = mode === 'edit' ? {
  // Modo EDIT: Usar estructura que backend espera en ProductUpdate
  name: data.name,
  description: data.description,
  precio_venta: data.precio_venta,
  precio_costo: data.precio_costo,
  peso: data.peso,                    // ‚úÖ Directo, no objeto
  dimensiones: {                      // ‚úÖ Espa√±ol
    largo: data.largo,                // ‚úÖ Espa√±ol
    ancho: data.ancho,                // ‚úÖ Espa√±ol
    alto: data.alto                   // ‚úÖ Espa√±ol
  },
  categoria: data.category || null,   // ‚úÖ null en lugar de undefined
  stock: data.stock
} : {
  // Modo CREATE: Usar estructura actual (si funciona)
  name: data.name,
  description: data.description,
  price: data.precio_venta,
  stock: data.stock,
  category: data.category,
  sku: data.sku,
  dimensions: {
    length: data.largo,
    width: data.ancho,
    height: data.alto,
    unit: 'cm'
  },
  weight: {
    value: data.peso,
    unit: 'kg'
  }
};
```

**Justificaci√≥n**:
- Backend espera estructura diferente seg√∫n el schema (ProductCreate vs ProductUpdate)
- ProductUpdate schema define: `peso: Optional[Decimal]`, `dimensiones: Optional[Dict[str, float]]`
- Elimina transformaci√≥n innecesaria que puede causar errores

---

### Soluci√≥n 3: Ajustar Validaci√≥n Backend (OPCIONAL - BAJA PRIORIDAD)

**Archivo**: `/home/admin-jairo/MeStore/app/schemas/product.py`  
**L√≠neas**: 439-446

**ANTES**:
```python
if v < 0.001:
    raise ValueError("Peso m√≠nimo: 0.001 kg")
```

**DESPU√âS** (opci√≥n A - m√°s restrictivo):
```python
if v <= 0.001:
    raise ValueError("Peso m√≠nimo debe ser mayor a 0.001 kg")
```

**DESPU√âS** (opci√≥n B - margen de seguridad):
```python
if v < 0.0011:  # Margen para precisi√≥n de floats
    raise ValueError("Peso m√≠nimo: 0.001 kg")
```

**Justificaci√≥n**:
- Evita ambig√ºedad con valores exactos en el l√≠mite
- Problemas de precisi√≥n de punto flotante pueden causar `0.001 == 0.0009999...`
- Consistente con la sem√°ntica de "m√≠nimo" (debe ser mayor o igual)

**Nota**: Esta soluci√≥n es OPCIONAL ya que el problema real est√° en el frontend

---

## üì¶ PLAN DE IMPLEMENTACI√ìN RECOMENDADO

### Fase 1: Fix Inmediato (Frontend - 30 minutos)
1. ‚úÖ Corregir valores por defecto en ProductForm.tsx (Soluci√≥n 1)
2. ‚úÖ Separar transformaci√≥n CREATE/UPDATE (Soluci√≥n 2)
3. ‚úÖ Testing manual con casos de prueba

### Fase 2: Testing Completo (1 hora)
1. ‚úÖ Crear producto nuevo con dimensiones m√≠nimas
2. ‚úÖ Editar producto existente SIN dimensiones previas
3. ‚úÖ Editar producto existente CON dimensiones previas
4. ‚úÖ Probar con peso exactamente 0.001 kg
5. ‚úÖ Validar que `categoria: undefined` se maneje correctamente
6. ‚úÖ Probar edge cases (valores negativos, muy grandes, etc.)

### Fase 3: Ajustes Backend (Opcional - 1 hora)
1. ‚ö†Ô∏è Revisar si ProductCreate tambi√©n necesita validaci√≥n consistente
2. ‚ö†Ô∏è Agregar margen de seguridad en validaci√≥n de peso (Soluci√≥n 3)
3. ‚ö†Ô∏è Documentar reglas de validaci√≥n en OpenAPI/Swagger

### Fase 4: Documentaci√≥n y Prevenci√≥n (1 hora)
1. üìù Documentar estructura esperada por cada endpoint (CREATE vs UPDATE)
2. üìù Agregar tests unitarios en frontend para validar transformaci√≥n de datos
3. üìù Agregar tests de integraci√≥n backend-frontend
4. üìù Actualizar documentaci√≥n de API

---

## üéØ IMPACTO Y USUARIOS AFECTADOS

### Severidad del Bug
- **Nivel**: ALTA
- **Frecuencia**: MEDIA (solo afecta productos sin dimensiones previas)
- **Detectabilidad**: ALTA (error visible inmediatamente en UI)

### Usuarios Afectados
1. ‚úÖ Vendedores editando productos existentes sin dimensiones previas
2. ‚úÖ Productos creados antes de implementar validaciones estrictas de dimensiones
3. ‚úÖ Cualquier producto con peso exactamente 0.001 kg
4. ‚úÖ Usuarios que dejan campos de dimensiones vac√≠os y presionan guardar

### Escenarios de Fallo
1. **Editar producto antiguo**: Producto creado cuando dimensiones eran opcionales ‚Üí Falla al guardar
2. **Copiar producto**: Copiar producto sin dimensiones ‚Üí Falla al crear copia
3. **Importaci√≥n masiva**: Productos importados sin dimensiones ‚Üí Falla actualizaci√≥n individual
4. **Formulario parcial**: Usuario actualiza solo nombre/precio ‚Üí Falla si dimensiones son 0

---

## üìÇ ARCHIVOS AFECTADOS

### Backend (Lectura - NO Modificar)
| Archivo | L√≠neas | Descripci√≥n |
|---------|--------|-------------|
| `/app/schemas/product.py` | 334-468 | Schema ProductUpdate con validaciones |
| `/app/api/v1/endpoints/productos.py` | 390-440 | Endpoint PUT /productos/{id} |
| `/app/models/product.py` | - | Modelo Product de SQLAlchemy |

### Frontend (Modificaci√≥n Requerida)
| Archivo | L√≠neas | Cambio Requerido |
|---------|--------|------------------|
| `/frontend/src/components/forms/ProductForm.tsx` | 86-99 | ‚úÖ Corregir valores por defecto |
| `/frontend/src/components/forms/ProductForm.tsx` | 323-362 | ‚úÖ Separar l√≥gica CREATE/UPDATE |
| `/frontend/src/services/api.ts` | 140 | ‚ö†Ô∏è Revisar si necesita ajuste |

---

## üî¨ TESTING EJECUTADO

### Tests Automatizados Realizados
1. ‚úÖ Test con valores problem√°ticos (peso=0.001, dimensiones=0) ‚Üí FALL√ì como esperado
2. ‚úÖ Test con valores corregidos (peso=0.01, dimensiones>0) ‚Üí EXITOSO
3. ‚úÖ Verificaci√≥n de logs del backend ‚Üí Error capturado correctamente
4. ‚úÖ Validaci√≥n de schema ProductUpdate ‚Üí Confirmado comportamiento

### Comandos de Testing
```bash
# Test de validaci√≥n con valores problem√°ticos
curl -X PUT "http://192.168.1.137:8000/api/v1/productos/{id}" \
  -H "Content-Type: application/json" \
  -d '{"peso": 0.001, "dimensiones": {"largo": 0, "ancho": 0, "alto": 0}}'
# Resultado: 422 Validation Error ‚úÖ Confirmado

# Test de validaci√≥n con valores correctos
curl -X PUT "http://192.168.1.137:8000/api/v1/productos/{id}" \
  -H "Content-Type: application/json" \
  -d '{"peso": 0.01, "dimensiones": {"largo": 14.7, "ancho": 7.15, "alto": 0.78}}'
# Resultado: 200 OK ‚úÖ Confirmado
```

---

## üìù CONCLUSI√ìN

El error 422 Validation Error en PUT /productos es causado por una combinaci√≥n de:

1. **Valores por defecto inv√°lidos** en el formulario frontend (dimensiones = 0, peso = 0.001)
2. **Problema de precisi√≥n de punto flotante** con peso exactamente en el l√≠mite inferior (0.001)
3. **Validaci√≥n estricta en backend** que rechaza valores cero en dimensiones

### Recomendaci√≥n Final
**ACCI√ìN INMEDIATA**: Implementar Soluci√≥n 1 + Soluci√≥n 2 en el frontend

1. ‚úÖ Corregir valores por defecto a m√≠nimos v√°lidos seguros
2. ‚úÖ Separar l√≥gica de transformaci√≥n de datos entre modo CREATE y modo UPDATE
3. ‚ö†Ô∏è (Opcional) Agregar margen de seguridad en validaci√≥n backend de peso

### Next Steps
1. Implementar cambios en ProductForm.tsx
2. Ejecutar suite completa de tests
3. Validar en ambiente de desarrollo
4. Deploy a staging para validaci√≥n final
5. Monitorear logs despu√©s del deploy a producci√≥n

---

**Status**: ‚úÖ AN√ÅLISIS COMPLETO - SOLUCI√ìN VALIDADA  
**Responsable de Fix**: Frontend Team (React Specialist)  
**Revisi√≥n Requerida**: Backend Team (API Architect) - Opcional  
**ETA Fix**: 2 horas (desarrollo + testing)

---

## üìû CONTACTO Y ESCALACI√ìN

**Agente Reportador**: api-testing-specialist  
**Workspace Office**: `.workspace/departments/testing/api-testing-specialist/`  
**Protocolo Seguido**: ‚úÖ Consultado PROTECTED_FILES.md, SYSTEM_RULES.md

**Agentes Responsables**:
- `react-specialist-ai` - Frontend fix (Soluci√≥n 1 + 2)
- `backend-framework-ai` - Backend review (Soluci√≥n 3, opcional)
- `system-architect-ai` - Validaci√≥n de arquitectura

**Para dudas o seguimiento**:
```bash
python .workspace/scripts/contact_responsible_agent.py api-testing-specialist \
  frontend/src/components/forms/ProductForm.tsx \
  "Implementar fix para validaci√≥n 422 en PUT /productos"
```

---

**Documento generado**: 2025-09-30 21:05:00  
**√öltima actualizaci√≥n**: 2025-09-30 21:05:00  
**Versi√≥n**: 1.0.0
