# ~/postgres/postgresql.prod.conf
# ---------------------------------------------------------------------------------------------
# MESTORE - PostgreSQL Production Configuration
# Copyright (c) 2025 Jairo. Todos los derechos reservados.
# Licensed under the proprietary license detailed in a LICENSE file in the root of this project.
# ---------------------------------------------------------------------------------------------
#
# Nombre del Archivo: postgresql.prod.conf
# Ruta: ~/postgres/postgresql.prod.conf
# Autor: DevOps Integration AI
# Fecha de Creación: 2025-09-17
# Última Actualización: 2025-09-17
# Versión: 1.0.0
# Propósito: Configuración PostgreSQL optimizada para producción
#            Performance, seguridad y alta disponibilidad
#
# Modificaciones:
# 2025-09-17 - Configuración inicial de producción
#
# ---------------------------------------------------------------------------------------------

# ===== NETWORK SETTINGS =====
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# ===== MEMORY CONFIGURATION =====
# Configuración para servidor con 4GB RAM (ajustar según recursos)
shared_buffers = 1GB                    # 25% de RAM disponible
effective_cache_size = 3GB              # 75% de RAM disponible
work_mem = 4MB                          # Para queries complejas
maintenance_work_mem = 256MB            # Para VACUUM, CREATE INDEX
temp_buffers = 8MB                      # Para queries temporales

# ===== WRITE AHEAD LOG (WAL) =====
wal_level = replica                     # Para replicación
max_wal_size = 1GB                      # Tamaño máximo de WAL
min_wal_size = 80MB                     # Tamaño mínimo de WAL
wal_compression = on                    # Comprimir WAL
wal_buffers = 16MB                      # Buffer para WAL
checkpoint_completion_target = 0.9      # Distribuir checkpoints
max_wal_senders = 3                     # Para replicación

# ===== QUERY PLANNER =====
random_page_cost = 1.1                 # Para SSD storage
effective_io_concurrency = 200         # Para SSD paralelo
default_statistics_target = 100        # Estadísticas detalladas

# ===== LOGGING =====
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 10MB
log_min_duration_statement = 1000      # Log queries > 1 segundo
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB
log_autovacuum_min_duration = 0
log_error_verbosity = default

# ===== AUTOVACUUM =====
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

# ===== BACKGROUND WRITER =====
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# ===== SECURITY =====
ssl = off                              # Manejar SSL en proxy/load balancer
password_encryption = scram-sha-256    # Encriptación segura
shared_preload_libraries = 'pg_stat_statements'

# ===== PERFORMANCE EXTENSIONS =====
# pg_stat_statements para monitoreo de queries
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# ===== CONNECTION POOLING =====
# Configurado externamente con PgBouncer si es necesario

# ===== REPLICATION =====
hot_standby = on                       # Para read replicas
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s
wal_receiver_status_interval = 10s
hot_standby_feedback = on

# ===== LOCK MANAGEMENT =====
deadlock_timeout = 1s
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

# ===== MAINTENANCE =====
vacuum_cost_delay = 10ms
vacuum_cost_limit = 200
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20

# ===== ERROR HANDLING =====
restart_after_crash = on
exit_on_error = off

# ===== LOCALE =====
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# ===== TIMEZONE =====
timezone = 'UTC'
log_timezone = 'UTC'

# ===== ADDITIONAL OPTIMIZATIONS =====
# Para aplicaciones web con muchas conexiones cortas
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# Configuraciones específicas para marketplace
max_prepared_transactions = 100       # Para transacciones distribuidas
enable_partitionwise_join = on        # Para tablas particionadas
enable_partitionwise_aggregate = on
jit = off                             # Puede causar latencia en queries rápidas

# ===== MONITORING Y STATS =====
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = 'pg_stat_tmp'

# ===== ARCHIVE MODE (para backups) =====
archive_mode = on
archive_command = 'cp %p /backups/wal/%f'
archive_timeout = 1800s               # 30 minutos

# ===== CUSTOM CONFIGURATIONS =====
# Configuraciones específicas para MeStore
shared_preload_libraries = 'pg_stat_statements'

# Configurar para transacciones de e-commerce
default_transaction_isolation = 'read committed'
synchronous_commit = on               # Crítico para transacciones financieras