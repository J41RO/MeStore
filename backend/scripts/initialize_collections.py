#!/usr/bin/env python3
"""
Script para inicializar colecciones base de ChromaDB para agentes IA.

Colecciones creadas:
- products: Embeddings de productos del marketplace
- docs: Embeddings de documentaci√≥n y conocimiento
- chat: Embeddings de conversaciones y contexto de chat

Caracter√≠sticas:
- Verificaci√≥n previa: no duplica colecciones existentes
- Metadata descriptiva para identificaci√≥n
- Logging detallado de operaciones
- Persistencia verificada
"""

import sys
import os
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Any

# Agregar el directorio backend al path para imports
backend_dir = Path(__file__).parent.parent
sys.path.append(str(backend_dir))

try:
    import chromadb
    from chromadb.config import Settings
except ImportError as e:
    print(f"‚ùå ERROR: ChromaDB no disponible: {e}")
    print("üí° Instalar con: pip install chromadb")
    sys.exit(1)


class CollectionInitializer:
    """Inicializador de colecciones base para agentes IA."""
    
    # Definici√≥n de colecciones con metadata
    COLLECTIONS_CONFIG = {
        "products": {
            "metadata": {
                "type": "agent_store",
                "purpose": "product_embeddings",
                "agent_type": "marketplace",
                "description": "Embeddings de productos del marketplace para b√∫squeda sem√°ntica",
                "created_by": "initialize_collections_script",
                "version": "1.0.0"
            }
        },
        "docs": {
            "metadata": {
                "type": "agent_store",
                "purpose": "documentation_embeddings",
                "agent_type": "knowledge",
                "description": "Embeddings de documentaci√≥n y base de conocimiento",
                "created_by": "initialize_collections_script",
                "version": "1.0.0"
            }
        },
        "chat": {
            "metadata": {
                "type": "agent_store",
                "purpose": "conversation_embeddings",
                "agent_type": "conversational",
                "description": "Embeddings de conversaciones y contexto de chat",
                "created_by": "initialize_collections_script",
                "version": "1.0.0"
            }
        }
    }
    
    def __init__(self, persist_directory: str = "./chroma_db"):
        """Inicializar el cliente ChromaDB con persistencia."""
        self.persist_directory = persist_directory
        self.client = None
        self._initialize_client()
    
    def _initialize_client(self) -> None:
        """Inicializar cliente ChromaDB con configuraci√≥n de persistencia."""
        try:
            # Configurar cliente con persistencia
            self.client = chromadb.PersistentClient(
                path=self.persist_directory,
                settings=Settings(
                    anonymized_telemetry=False,
                    is_persistent=True
                )
            )
            print(f"‚úÖ Cliente ChromaDB inicializado con persistencia en: {self.persist_directory}")
            
        except Exception as e:
            print(f"‚ùå ERROR inicializando cliente ChromaDB: {e}")
            raise
    
    def get_existing_collections(self) -> List[str]:
        """Obtener lista de colecciones existentes."""
        try:
            collections = self.client.list_collections()
            collection_names = [col.name for col in collections]
            
            if collection_names:
                print(f"üìã Colecciones existentes encontradas: {collection_names}")
            else:
                print("üìã No hay colecciones existentes")
            
            return collection_names
            
        except Exception as e:
            print(f"‚ùå ERROR listando colecciones: {e}")
            return []
    
    def create_collection_if_not_exists(self, name: str, config: Dict[str, Any]) -> bool:
        """Crear colecci√≥n si no existe."""
        try:
            existing_collections = self.get_existing_collections()
            
            if name in existing_collections:
                print(f"‚ÑπÔ∏è Colecci√≥n '{name}' ya existe - saltando creaci√≥n")
                
                # Obtener informaci√≥n de la colecci√≥n existente
                collection = self.client.get_collection(name)
                count = collection.count()
                print(f"   üìä Documentos actuales en '{name}': {count}")
                return False
            
            # Crear nueva colecci√≥n
            print(f"üîß Creando colecci√≥n '{name}'...")
            
            # Agregar timestamp a metadata
            metadata = config["metadata"].copy()
            metadata["created_at"] = datetime.now().isoformat()
            
            collection = self.client.create_collection(
                name=name,
                metadata=metadata
            )
            
            print(f"‚úÖ Colecci√≥n '{name}' creada exitosamente")
            print(f"   üìã Metadata: {metadata['purpose']}")
            print(f"   üéØ Agente: {metadata['agent_type']}")
            
            return True
            
        except Exception as e:
            print(f"‚ùå ERROR creando colecci√≥n '{name}': {e}")
            return False
    
    def initialize_all_collections(self) -> Dict[str, bool]:
        """Inicializar todas las colecciones definidas."""
        print("=== üöÄ INICIALIZANDO COLECCIONES BASE PARA AGENTES IA ===")
        print(f"üìç Directorio de persistencia: {self.persist_directory}")
        print(f"‚è∞ Timestamp: {datetime.now().isoformat()}")
        print()
        
        results = {}
        
        for collection_name, config in self.COLLECTIONS_CONFIG.items():
            print(f"üîç Procesando colecci√≥n: '{collection_name}'")
            created = self.create_collection_if_not_exists(collection_name, config)
            results[collection_name] = created
            print()
        
        return results
    
    def verify_collections(self) -> bool:
        """Verificar que todas las colecciones est√©n creadas correctamente."""
        print("=== üîç VERIFICACI√ìN DE COLECCIONES ===")
        
        try:
            existing_collections = self.get_existing_collections()
            expected_collections = list(self.COLLECTIONS_CONFIG.keys())
            
            # Verificar que todas las colecciones esperadas existan
            missing_collections = []
            for expected in expected_collections:
                if expected not in existing_collections:
                    missing_collections.append(expected)
            
            if missing_collections:
                print(f"‚ùå FALTA(N) COLECCI√ìN(ES): {missing_collections}")
                return False
            
            # Verificar cada colecci√≥n individualmente
            print("üìä Estado detallado de colecciones:")
            for collection_name in expected_collections:
                try:
                    collection = self.client.get_collection(collection_name)
                    count = collection.count()
                    metadata = collection.metadata
                    
                    print(f"   ‚úÖ {collection_name}:")
                    print(f"      üìã Documentos: {count}")
                    print(f"      üéØ Prop√≥sito: {metadata.get('purpose', 'N/A')}")
                    print(f"      ü§ñ Agente: {metadata.get('agent_type', 'N/A')}")
                    print(f"      üìÖ Creado: {metadata.get('created_at', 'N/A')}")
                    
                except Exception as e:
                    print(f"   ‚ùå Error accediendo a {collection_name}: {e}")
                    return False
            
            print()
            print("‚úÖ TODAS LAS COLECCIONES VERIFICADAS CORRECTAMENTE")
            return True
            
        except Exception as e:
            print(f"‚ùå ERROR en verificaci√≥n: {e}")
            return False
    
    def test_persistence(self) -> bool:
        """Probar que la persistencia funciona correctamente."""
        print("=== üß™ PRUEBA DE PERSISTENCIA ===")
        
        try:
            # Crear un nuevo cliente para simular reinicio
            print("üîÑ Simulando reinicio del sistema...")
            test_client = chromadb.PersistentClient(
                path=self.persist_directory,
                settings=Settings(
                    anonymized_telemetry=False,
                    is_persistent=True
                )
            )
            
            # Verificar que las colecciones persisten
            collections = test_client.list_collections()
            collection_names = [col.name for col in collections]
            expected_collections = list(self.COLLECTIONS_CONFIG.keys())
            
            missing_after_restart = []
            for expected in expected_collections:
                if expected not in collection_names:
                    missing_after_restart.append(expected)
            
            if missing_after_restart:
                print(f"‚ùå PERSISTENCIA FALL√ì: Colecciones perdidas: {missing_after_restart}")
                return False
            
            print(f"‚úÖ PERSISTENCIA VERIFICADA: {len(collection_names)} colecciones recuperadas")
            print(f"üìã Colecciones persistentes: {collection_names}")
            
            # Verificar archivos en disco
            chroma_path = Path(self.persist_directory)
            if chroma_path.exists():
                files = list(chroma_path.rglob("*"))
                print(f"üìÅ Archivos persistidos: {len(files)} archivos en disco")
            else:
                print("‚ö†Ô∏è Directorio de persistencia no encontrado")
                return False
            
            return True
            
        except Exception as e:
            print(f"‚ùå ERROR en prueba de persistencia: {e}")
            return False


def main():
    """Funci√≥n principal del script."""
    print("üöÄ INICIALIZADOR DE COLECCIONES CHROMADB v1.0.0")
    print("üìä Colecciones objetivo: products, docs, chat")
    print()
    
    try:
        # Inicializar el sistema
        initializer = CollectionInitializer()
        
        # Crear todas las colecciones
        results = initializer.initialize_all_collections()
        
        # Mostrar resumen de creaci√≥n
        print("=== üìä RESUMEN DE CREACI√ìN ===")
        created_count = sum(1 for created in results.values() if created)
        existing_count = len(results) - created_count
        
        print(f"üÜï Colecciones creadas: {created_count}")
        print(f"üìã Colecciones existentes: {existing_count}")
        print(f"üìä Total de colecciones: {len(results)}")
        print()
        
        # Verificar todas las colecciones
        verification_success = initializer.verify_collections()
        
        if not verification_success:
            print("‚ùå VERIFICACI√ìN FALL√ì")
            sys.exit(1)
        
        # Probar persistencia
        persistence_success = initializer.test_persistence()
        
        if not persistence_success:
            print("‚ùå PRUEBA DE PERSISTENCIA FALL√ì")
            sys.exit(1)
        
        print("=== üéâ INICIALIZACI√ìN COMPLETADA EXITOSAMENTE ===")
        print("‚úÖ Las 3 colecciones base est√°n listas para los agentes IA")
        print("üîß Las colecciones persistir√°n entre reinicios del sistema")
        print("üìä Sistema ChromaDB completamente configurado")
        
    except Exception as e:
        print(f"‚ùå ERROR CR√çTICO: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
