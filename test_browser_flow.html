<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Autenticaci√≥n - MeStore</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>üß™ Test de Autenticaci√≥n MeStore</h1>

    <div class="section info">
        <h3>üìã Credenciales de Prueba</h3>
        <ul>
            <li><strong>COMPRADOR:</strong> buyer@mestore.com / 123456</li>
            <li><strong>VENDEDOR:</strong> vendor@mestore.com / 123456</li>
            <li><strong>ADMIN:</strong> admin@mestore.com / 123456</li>
            <li><strong>SUPERUSER:</strong> super@mestore.com / 123456</li>
        </ul>
    </div>

    <div class="section">
        <h3>üîê Prueba de Login</h3>
        <input type="email" id="email" placeholder="Email" value="vendor@mestore.com">
        <input type="password" id="password" placeholder="Password" value="123456">
        <br>
        <button onclick="testLogin()">üöÄ Probar Login</button>
        <button onclick="testLogout()">üö™ Logout</button>
        <button onclick="checkAuth()">üîç Verificar Estado</button>
        <button onclick="testDashboardAccess()">üìä Probar Dashboard</button>
    </div>

    <div class="section">
        <h3>üìä Resultados</h3>
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://192.168.1.137:8000/api/v1';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            log(`üîê Intentando login con: ${email}`, 'info');

            try {
                const endpoint = email.includes('admin') || email.includes('super') ? '/auth/admin-login' : '/auth/login';

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'MeStore-Frontend/1.0'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    const token = data.access_token;

                    // Simular lo que hace el frontend
                    localStorage.setItem('auth_token', token);

                    // Obtener datos del usuario
                    const userResponse = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'MeStore-Frontend/1.0'
                        }
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();

                        // Simular el store de Zustand
                        const authData = {
                            user: {
                                id: userData.id,
                                email: userData.email,
                                user_type: userData.user_type,
                                name: userData.nombre
                            },
                            token: token,
                            isAuthenticated: true
                        };

                        localStorage.setItem('auth-storage', JSON.stringify({
                            state: authData,
                            version: 0
                        }));

                        log(`‚úÖ Login exitoso! Rol: ${userData.user_type}`, 'success');
                        log(`üé´ Token guardado en localStorage`, 'success');
                        log(`üìã Datos del usuario: ${JSON.stringify(userData, null, 2)}`, 'info');

                        // Sugerir pr√≥ximo paso
                        const dashboardUrl = getDashboardUrl(userData.user_type);
                        log(`üîó Deber√≠as poder acceder a: <a href="${dashboardUrl}" target="_blank">${dashboardUrl}</a>`, 'info');

                    } else {
                        log(`‚ùå Error obteniendo datos del usuario: ${userResponse.status}`, 'error');
                    }

                } else {
                    const errorData = await response.text();
                    log(`‚ùå Error en login: ${response.status} - ${errorData}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        function getDashboardUrl(userType) {
            const baseUrl = 'http://localhost:5173';
            switch(userType) {
                case 'COMPRADOR': return `${baseUrl}/app/dashboard`;
                case 'VENDEDOR': return `${baseUrl}/app/vendor-dashboard`;
                case 'ADMIN':
                case 'SUPERUSER': return `${baseUrl}/admin-secure-portal/dashboard`;
                default: return `${baseUrl}/`;
            }
        }

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const authStorage = localStorage.getItem('auth-storage');

            if (token) {
                log(`üé´ Token encontrado: ${token.substring(0, 20)}...`, 'success');
            } else {
                log(`‚ùå No hay token en localStorage`, 'error');
            }

            if (authStorage) {
                try {
                    const parsed = JSON.parse(authStorage);
                    log(`üì¶ Auth storage encontrado:`, 'success');
                    log(`<pre>${JSON.stringify(parsed, null, 2)}</pre>`, 'info');
                } catch (e) {
                    log(`‚ùå Error parseando auth storage: ${e.message}`, 'error');
                }
            } else {
                log(`‚ùå No hay auth storage`, 'error');
            }
        }

        function testLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth-storage');
            log(`üö™ Logout realizado - localStorage limpiado`, 'success');
        }

        async function testDashboardAccess() {
            const frontendUrl = 'http://localhost:5173/app/dashboard';
            log(`üåê Intentando acceder a: ${frontendUrl}`, 'info');
            log(`üìù Abre esta URL en una nueva pesta√±a para probar el acceso`, 'info');
            window.open(frontendUrl, '_blank');
        }

        // Auto-check al cargar
        window.onload = () => {
            log('üîÑ P√°gina cargada - Verificando estado actual...', 'info');
            checkAuth();
        };
    </script>
</body>
</html>
